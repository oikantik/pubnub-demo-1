# Access Manager (v3)

> **Access Manager v2 is deprecated**
>
> This documentation describes Access Manager v3.
>
> If you use Access Manager in v2, you must migrate to the latest version (v3).

When you develop an in-app messaging application, you might want to set rules that would only allow a selected user to access specific channels and user metadata. This is where Access Manager comes in. With it, you can set up a detailed permission schema for your application and decide who can do what with your data. This way you secure your application and protect it against any unauthorized third-party access attempts.

Access Manager (v3) is a cryptographic, token-based permission administrator that allows you to regulate clients' access to PubNub resources, such as channels, channel groups, and User IDs. For instance, you can make a one-to-one chat room private by only allowing two users to be able to read and write messages in this channel. Alternatively, you can make a channel public by giving all users access to it. With Access Manager, you can define multiple permissions in a single API call by listing resource groups explicitly or creating patterns with regular expressions (RegEx).

> **User ID / UUID**
>
> User ID is also referred to as **`UUID`/`uuid`** in some APIs and server responses but **holds the value** of the **`userId`** parameter you set during initialization.

Applications built with Access Manager create tokens with individual permissions for each authorized user of the application. These tokens are generated by PubNub. A client device would need to acquire an appropriate token for its user and pass the token with any request made to the PubNub API.

> **Accepted tokens**
>
> Access Manager requires cryptographic tokens generated by PubNub to define detailed permissions for resources like channels and metadata. External tokens, such as JWTs, are not supported, ensuring that all permissions remain securely within the PubNub framework.

## Configuration

To use Access Manager, you must enable and configure it on a chosen app's keyset in the Admin Portal.

> **Public Admin Portal demo**
>
> Want to browse through the Admin Portal without creating an account? Explore it through the Public Demo that shows examples of most PubNub features for transport and logistics use case.

Access Manager in Admin Portal

| Option | Description |
| --- | --- |
| **Revoke v3 Token** | This feature lets you [invalidate](#revoke-permissions) a previously issued token so that it can no longer be used to authenticate requests for access to PubNub resources. |

## Authorization flow

There are three actors involved in the authorization process:

* **Server** - Client applications that use Access Manager require a centralized server application that keeps track of all interactions between the users and the PubNub resources they have access to. The server is solely authorized to request permission grants from PubNub using the `secretKey`. It should also expose an API through which clients can request new or updated tokens. In-app messaging applications usually have a centralized server in place to support such operations as validation of users logging in to clients. The same server can be used to implement and manage the Access Manager logic in your application – sets permissions and specifies the `authorized_uuid`.
* **Client device** - A client that represents a single device where a user logs in to perform an operation supported by PubNub. For Access Manager-enabled applications, a client needs to request a token from the centralized server (a PubNub SDK instance initialized with `secretKey`), set it as the client's `authKey` so that it's used for making secured PubNub API calls and attempting to access resources such as channels, channel groups, and User ID metadata. Clients also need logic to periodically refresh their user's token before it expires.
* **PubNub** - The PubNub platform provides APIs to support both centralized server applications and client devices associated with a particular user. Server applications call the grant API to generate or refresh tokens. Client applications pass these tokens in requests to PubNub APIs (such as publish or subscribe) for PubNub to validate that the user associated with the client has the appropriate permissions.

A typical client authorization could look as follows:

Client Devices → Your Server → PN Network ← Client Devices

1. Upon login, the client device requests authorization to be able to send requests to PubNub.
2. The server uses the `secretKey` to request a token from PubNub, defining the permissions it needs to give to a specific authorized User ID.
3. PubNub reads these permissions and returns a signed, self-contained, and time-limited access token to the server.
4. The server passes the token to the client device as part of the login response.
5. The client includes the token (also called `authKey`) in its SDK configuration using the received token.
6. The client uses the token to make API calls, which PubNub validates against the permissions tied to the authorized User ID. It can continue to do so until the token expires or is revoked, at which point it needs to request a new token to be issued.

This flow ensures that only authorized users access specific PubNub resources, maintaining security and control over user permissions.

## Server-side operations

A centralized server is an implementation that initializes with a server-side PubNub SDK authenticated by a `secretKey`. Permissions grants can only be requested by a server.

### Initialize with a secret key

The `secretKey` lets you use Access Manager to provide clients with access to PubNub resources, change access levels, and remove permissions. When you initialize PubNub with the `secretKey`, you get root permissions for Access Manager. With this feature, you don't have to grant access to your servers to access channel data as the servers get `read` and `write` access to all resources.

Paid plan customers can use secret key rotation to enhance security by automatically managing and expiring up to 5 secret keys, including the current key in use.

> **Secret key security**
>
> The `secretKey` should only be used within a secure server and never exposed to client devices. If the `secretKey` is ever compromised, it can be an extreme security risk to your application. If you suspect your `secretKey` has been compromised, you have the ability to regenerate a new `secretKey` for the existing PubNub keyset on the Admin Portal.

**Ruby:**
```ruby
pubnub = Pubnub.new(
    subscribe_key: 'my_subscribe_key',
    publish_key: 'my_publish_key',
    secret_key: 'my_secret_key',
    user_id: 'myUniqueUserId'
);
```

### Grant permissions

Once you've enabled Access Manager on the Admin Portal and initialized the PubNub object with a `secretKey`, you can assign permissions to client devices. To do this, make a call to the PubNub server in which you request it to grant a new token. Specify the authorized User ID which will use the token exclusively, its permissions to resources (provided in a sequence and/or as regular expressions), and a `ttl` (time to live) for the grant.

An authorized User ID can have permissions for:

* Channels
* Channel groups
* User IDs (which are other users' object metadata, such as their names or avatars)

Once the grant is successful, the server responds to the client device's authentication request by returning a token with embedded permissions.

**Ruby example (basic):**
```ruby
result = pubnub.grant_token(
  ttl: 15, # Time to live in minutes
  authorized_uuid: "my-authorized-uuid",
  resources: {
    channels: {
      "channel-a": {
        read: true
      },
      "channel-b": {
        read: true,
        write: true
      }
    },
    uuids: {
      "uuid-c": {
        read: true
      }
    }
  }
)
```

### Change permissions

When a user's permissions need to be modified (for example, when they join or leave a channel), you need to update their token. This involves:

1. Revoking the current token (optional but recommended)
2. Generating a new token with updated permissions
3. Providing the new token to the client

To update permissions, use the same grant_token method but with the updated permissions.

### Revoke permissions

You can revoke a user's access by invalidating their token. This forces the user to request a new token to continue using PubNub services. To revoke a token:

```ruby
result = pubnub.revoke_token(
  token: "previously-issued-token"
)
```

## Client-side operations

Client devices need to acquire and use tokens to access PubNub resources according to their permissions.

### Initialize with an auth key

Once a client has obtained a token, it needs to initialize the PubNub SDK with it:

```ruby
# Client-side code
pubnub = Pubnub.new(
  subscribe_key: 'my_subscribe_key',
  publish_key: 'my_publish_key',
  auth_key: 'token-received-from-server',
  user_id: 'myUniqueUserId'
)
```

### Check permissions

Clients can verify their permissions to ensure they have access to the resources they need:

```ruby
token_info = pubnub.parse_token(
  token: 'token-received-from-server'
)
```

### Request a new token

Clients should request a new token when:
- Their current token is about to expire
- They need access to new resources
- Their token has been revoked

This is typically done through a custom API endpoint on your server.

## Token expiration

Tokens have a limited lifetime specified by the `ttl` parameter when they're created.

### Update a valid token

To keep the user session active, clients should refresh their tokens before they expire. Best practices:

1. Set reasonable token TTLs based on your application's security requirements.
2. Implement a token refresh strategy that gets new tokens before the current ones expire.
3. Handle failed requests due to expired tokens gracefully.

### Update an expired token

When a token expires, PubNub returns an HTTP 403 error. To recover:

1. Request a new token from your server.
2. Set the new token using the pubnub.set_token() method.
3. Reconnect to PubNub.
4. Retry the failed request.

## Permissions

Access Manager v3 allows the following permissions for different resources:

| Resource | Available Permissions |
| --- | --- |
| Channel | read, write, delete, get, update, manage, join |
| Channel Group | read, manage |
| UUID Metadata | get, update, delete |

### Operations to permissions mapping

Here's a summary of which operations require which permissions:

#### Pub/Sub

| PubNub Operation | Resource | Permission |
| --- | --- | --- |
| Publish on channel | Channel | Write |
| Signal on channel | Channel | Write |
| Subscribe to channel | Channel | Read |
| Subscribe to presence channel | Presence Channel (-pnpres) | Read |
| Subscribe to channel group | Channel Group | Read |
| Subscribe to presence channel group | Presence Channel Group (-pnpres) | Read |
| Unsubscribe from channel | Channel | None required |
| Unsubscribe from channel group | Channel Group | None required |

#### Presence

| PubNub Operation | Resource | Permission |
| --- | --- | --- |
| Here Now | Channel | Read |
| Where Now | Channel | None required |
| Get State | Channel | Read |
| Set State | Channel | Read |

#### Message Persistence

| PubNub Operation | Resource | Permission |
| --- | --- | --- |
| History - Fetch Messages | Channel | Read |
| Message Counts | Channel | Read |
| Delete Messages | Channel | Delete |

For a complete list of permissions required for all operations, refer to the [PubNub documentation](https://www.pubnub.com/docs/general/security/access-control). 